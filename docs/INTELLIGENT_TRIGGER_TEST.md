# 智能触发功能测试指南

## 📋 测试目标

验证智能触发功能是否正常工作，包括：
1. 默认触发条件是否有效
2. 群组配置是否生效
3. 超级管理员命令是否可用
4. 图片识别是否正常

---

## 🧪 测试准备

### 1. 环境准备

确保机器人已经启动并正常运行：

```bash
# 检查机器人状态
ps aux | grep python

# 查看日志
tail -f logs/nonebot.log
```

### 2. 创建测试群

建议创建一个专门的测试群，避免影响正常使用的群。

### 3. 准备测试账号

- 超级管理员账号（配置在 .env 的 SUPERUSERS）
- 普通用户账号（用于测试普通用户触发）

---

## ✅ 测试步骤

### 测试1：默认触发条件验证

**测试目标：** 验证默认触发条件是否有效

**步骤：**

1. 在测试群中发送以下消息，验证是否触发：

   | 消息内容 | 预期结果 |
   |---------|---------|
   | `这个问题怎么解决？` | ✅ 应该触发 |
   | `有人知道吗？` | ✅ 应该触发 |
   | `怎么弄？` | ✅ 应该触发 |
   | `求解答` | ✅ 应该触发 |
   | `@机器人 帮忙` | ✅ 应该触发 |
   | `今天天气不错` | ❌ 不应该触发 |
   | `大家吃饭了吗？` | ❌ 不应该触发 |
   | `哈喽` | ❌ 不应该触发 |

2. 查看日志确认：

```bash
tail -f logs/nonebot.log | grep "智能触发"
```

**预期输出：**
```
[INFO] 🎯 智能触发 (群: 123456789, 用户: 987654321): 这个问题怎么解决？
```

### 测试2：群组配置验证

**测试目标：** 验证群组配置是否生效

**步骤：**

1. 查看当前智能触发状态：

```
/trigger_status
```

2. 禁用测试群的智能触发：

```
/trigger_disable 123456789
```

3. 再次发送触发消息：

```
这个问题怎么解决？
```

**预期结果：** 不应该触发（机器人不回复）

4. 重新启用：

```
/trigger_enable 123456789
```

5. 再次发送触发消息：

```
这个问题怎么解决？
```

**预期结果：** 应该触发（机器人回复）

### 测试3：群组定制配置验证

**测试目标：** 验证群组定制配置是否生效

**步骤：**

1. 设置测试群为强制@模式：

```
/trigger_set 123456789 启用 是
```

2. 发送触发消息（不带@）：

```
这个问题怎么解决？
```

**预期结果：** 不应该触发（因为没有@）

3. 发送带@的消息：

```
@机器人 这个问题怎么解决？
```

**预期结果：** 应该触发

4. 重置为默认配置：

```
/trigger_reset 123456789
```

5. 再次测试（不带@）：

```
这个问题怎么解决？
```

**预期结果：** 应该触发（已恢复默认配置）

### 测试4：超级管理员命令验证

**测试目标：** 验证所有超级管理员命令是否可用

**步骤：**

依次执行以下命令，验证输出：

| 命令 | 预期结果 |
|------|---------|
| `/trigger_status` | 显示全局配置 |
| `/trigger_list` | 显示所有群配置 |
| `/trigger_enable 123456789` | 启用成功 |
| `/trigger_disable 123456789` | 禁用成功 |
| `/trigger_set 123456789 启用 是` | 设置成功 |
| `/trigger_reset 123456789` | 重置成功 |

### 测试5：图片识别验证

**测试目标：** 验证图片识别功能是否正常

**步骤：**

1. 发送一张图片（不带文字）：

```
[图片]
```

**预期结果：** 机器人描述图片内容

2. 发送一张图片 + 问题：

```
[图片]
这张图里是什么？
```

**预期结果：** 机器人结合图片回答问题

### 测试6：上下文验证

**测试目标：** 验证机器人是否能正确使用上下文

**步骤：**

1. 发送一系列消息：

```
A: 我在写 Python 代码
B: 好的
C: 哦
D: 这个函数怎么写？
```

**预期结果：** 机器人应该能理解"这个函数"是指 Python 函数，并给出相关建议

2. 查看配置的历史上下文数量：

```bash
/trigger_status
```

**预期输出：**
```
• 历史上下文：20 条消息
```

---

## 🔍 常见问题排查

### 问题1：消息不触发

**排查步骤：**

1. 检查智能触发是否启用：

```bash
/trigger_status
```

2. 检查群组配置：

```bash
/trigger_list
```

3. 查看日志：

```bash
tail -f logs/nonebot.log
```

4. 检查触发模式是否匹配：

- 确认消息中包含问号或触发词
- 确认消息不是以命令符号开头（`/`、`.`、`。`、`！`、`!`）

### 问题2：回复太频繁

**排查步骤：**

1. 检查触发模式是否过于宽松：

```bash
cat .env | grep INTELLIGENT_TRIGGER_PATTERNS
```

2. 调整触发模式，使其更精确：

```ini
# 修改 .env
INTELLIGENT_TRIGGER_PATTERNS=["[？?]", "(求|帮|解答|请教)"]
```

3. 重启机器人：

```bash
# 停止
Ctrl+C

# 启动
bash start.sh
```

### 问题3：超级管理员命令无法使用

**排查步骤：**

1. 检查 .env 中的 SUPERUSERS 配置：

```bash
cat .env | grep SUPERUSERS
```

2. 确认发送命令的 QQ 号在超级管理员列表中：

```ini
SUPERUSERS=["你的QQ号"]
```

3. 检查机器人日志是否有权限错误：

```bash
tail -f logs/nonebot.log | grep "权限"
```

### 问题4：群组配置丢失

**排查步骤：**

1. 检查配置文件是否存在：

```bash
ls -la group_configs.json
```

2. 如果文件不存在，重新配置：

```bash
/trigger_enable 123456789
```

3. 检查文件权限：

```bash
chmod 644 group_configs.json
```

---

## 📊 测试结果记录

### 测试记录表

| 测试项 | 测试结果 | 备注 |
|--------|---------|------|
| 默认触发条件验证 | ⬜ 通过 / ⬜ 失败 | |
| 群组配置验证 | ⬜ 通过 / ⬜ 失败 | |
| 群组定制配置验证 | ⬜ 通过 / ⬜ 失败 | |
| 超级管理员命令验证 | ⬜ 通过 / ⬜ 失败 | |
| 图片识别验证 | ⬜ 通过 / ⬜ 失败 | |
| 上下文验证 | ⬜ 通过 / ⬜ 失败 | |

---

## ✨ 测试通过标准

所有测试项均通过，则表示智能触发功能正常工作。

**如有任何测试失败，请：**

1. 查看日志文件
2. 参考常见问题排查
3. 提交 Issue 到 GitHub

---

**文档版本：1.0.0**
**最后更新：2026-02-16**
