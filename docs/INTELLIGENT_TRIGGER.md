# 智能触发功能详细文档

## 📋 目录

- [功能概述](#功能概述)
- [工作原理](#工作原理)
- [配置说明](#配置说明)
- [触发模式](#触发模式)
- [群组配置](#群组配置)
- [超级管理员命令](#超级管理员命令)
- [常见问题](#常见问题)

---

## 功能概述

智能触发模式是 QQ Bot 的一项核心功能，它允许机器人自动检测群消息中的疑问和求助，并主动回复，无需 @机器人。

### 主要特点

- **自动检测**：无需手动 @机器人，自动识别需要回复的消息
- **灵活配置**：支持全局默认配置和群组定制配置
- **正则表达式**：使用强大的正则表达式匹配触发条件
- **上下文感知**：支持查看最近的消息作为上下文
- **超级管理员控制**：完全由超级管理员控制配置

---

## 工作原理

### 消息处理流程

```
1. 群消息接收
   ↓
2. 检查是否@
   ├─ 是 → @机器人处理器（chat）优先处理
   └─ 否 → 继续下一步
   ↓
3. 检查智能触发
   ├─ 触发 → 智能触发处理器（intelligent_chat）
   └─ 未触发 → 忽略
   ↓
4. AI 处理并回复
```

### 触发检测逻辑

1. 检查消息是否为空
2. 检查消息是否为命令（以 `/`、`.`、`。`、`！`、`!` 开头）
3. 检查群组的智能触发配置是否启用
4. 检查是否强制要求 @（如果配置为是，则跳过）
5. 使用正则表达式匹配触发模式
6. 匹配成功 → 触发回复
7. 匹配失败 → 忽略

---

## 配置说明

### 全局默认配置

在 `.env` 文件中配置：

```ini
# ========== 智能触发配置 ==========
# 是否启用智能触发模式（true/false）
INTELLIGENT_TRIGGER_ENABLED=true

# 是否强制要求 @ 机器人（true/false）
INTELLIGENT_TRIGGER_REQUIRE_MENTION=false

# 触发模式（正则表达式列表，JSON 格式）
INTELLIGENT_TRIGGER_PATTERNS=["[？?]", "(有人|谁|怎么|如何|为什么|求|帮|解答|请教)", "(@机器人|@[Aa][Uu][Tt][Oo]|@[Bb][Oo][Tt])"]

# 查看最近多少条消息作为上下文
INTELLIGENT_TRIGGER_HISTORY_LIMIT=20

# 群组配置文件路径
GROUP_CONFIG_FILE=group_configs.json
```

### 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `INTELLIGENT_TRIGGER_ENABLED` | bool | `true` | 是否全局启用智能触发 |
| `INTELLIGENT_TRIGGER_REQUIRE_MENTION` | bool | `false` | 是否强制要求 @机器人 |
| `INTELLIGENT_TRIGGER_PATTERNS` | list | `[...]` | 触发模式列表（正则表达式） |
| `INTELLIGENT_TRIGGER_HISTORY_LIMIT` | int | `20` | 查看最近的消息数量作为上下文 |
| `GROUP_CONFIG_FILE` | string | `group_configs.json` | 群组配置文件路径 |

---

## 触发模式

### 默认触发模式

```python
[
    "[？?]",  # 包含问号
    "(有人|谁|怎么|如何|为什么|求|帮|解答|请教)",  # 疑问/求助词
    "(@机器人|@[Aa][Uu][Tt][Oo]|@[Bb][Oo][Tt])"  # 显式触发
]
```

### 常用触发模式示例

#### 1. 疑问句检测
```python
["[？?]"]  # 匹配中文或英文问号
```
**示例：**
- ✅ "这个问题怎么解决？"
- ✅ "What is this?"
- ❌ "今天天气不错"

#### 2. 疑问词检测
```python
["(有人|谁|怎么|如何|为什么|求|帮|解答|请教)"]
```
**示例：**
- ✅ "有人知道吗？"
- ✅ "怎么弄？"
- ✅ "求解答"
- ❌ "大家吃饭了吗？"

#### 3. 技术问题检测
```python
["(技术|代码|bug|问题|报错|调试|错误)"]
```
**示例：**
- ✅ "代码报错了"
- ✅ "有 bug 怎么办？"
- ✅ "技术问题求助"
- ❌ "今天学技术了吗"

#### 4. 紧急求助检测
```python
["(紧急|急|救命|帮忙|求助|求助)", "[？?]"]
```
**示例：**
- ✅ "紧急求助！"
- ✅ "救命啊！"
- ✅ "急急急！"

#### 5. 组合多个条件
```python
[
    "[？?]",                    # 条件1：包含问号
    "(求助|求解答|求教)",       # 条件2：求助词
    "(@机器人|@AUTO)"          # 条件3：显式触发
]
```
**逻辑：** 满足任意一个条件即触发（OR 关系）

### 正则表达式语法参考

| 语法 | 说明 | 示例 |
|------|------|------|
| `[]` | 字符集合 | `[？?]` - 匹配中文或英文问号 |
| `()` | 分组 | `(有人|谁)` - 匹配"有人"或"谁" |
| `\|` | 或 | `(a|b)` - 匹配 a 或 b |
| `?` | 可选 | `colou?r` - 匹配 color 或 colour |
| `*` | 零次或多次 | `a*` - 匹配 ""、"a"、"aa" 等 |
| `+` | 一次或多次 | `a+` - 匹配 "a"、"aa" 等 |
| `^` | 开头 | `^help` - 匹配以 help 开头 |
| `$` | 结尾 | `help$` - 匹配以 help 结尾 |

---

## 群组配置

### 配置文件结构

`group_configs.json` 文件示例：

```json
{
  "123456789": {
    "trigger_config": {
      "enabled": true,
      "require_mention": false,
      "mention_patterns": [
        "[？?]",
        "(有人|谁|怎么|如何|为什么|求|帮|解答|请教)",
        "(@机器人|@[Aa][Uu][Tt][Oo]|@[Bb][Oo][Tt])"
      ],
      "history_limit": 20
    }
  },
  "987654321": {
    "trigger_config": {
      "enabled": false,
      "require_mention": true,
      "mention_patterns": [],
      "history_limit": 10
    }
  }
}
```

### 配置项说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `enabled` | bool | 是否启用智能触发 |
| `require_mention` | bool | 是否强制要求 @机器人 |
| `mention_patterns` | list | 触发模式列表（正则表达式） |
| `history_limit` | int | 查看最近的消息数量作为上下文 |

### 常见配置场景

#### 场景1：技术讨论群（严格触发）
```json
{
  "123456789": {
    "trigger_config": {
      "enabled": true,
      "require_mention": false,
      "mention_patterns": [
        "[？?]",
        "(技术|代码|bug|问题|报错|调试)",
        "(@机器人|@HELP)"
      ],
      "history_limit": 50
    }
  }
}
```

#### 场景2：闲聊群（必须@）
```json
{
  "987654321": {
    "trigger_config": {
      "enabled": true,
      "require_mention": true,
      "mention_patterns": [],
      "history_limit": 10
    }
  }
}
```

#### 场景3：客服群（宽松触发）
```json
{
  "111222333": {
    "trigger_config": {
      "enabled": true,
      "require_mention": false,
      "mention_patterns": [
        "[？?]",
        "(求助|问题|咨询)",
        "(?![你好|哈喽|在吗])"
      ],
      "history_limit": 30
    }
  }
}
```

---

## 超级管理员命令

### 查看智能触发配置

```bash
/trigger_status
```

**输出示例：**
```
✨ 智能触发配置 💙

【全局默认配置】
• 启用状态：✅ 启用
• 是否强制@：❌ 否
• 历史上下文：20 条消息

【触发模式】
• [？?]
• (有人|谁|怎么|如何|为什么|求|帮|解答|请教)
• (@机器人|@[Aa][Uu][Tt][Oo]|@[Bb][Oo][Tt])

【群组配置】
• 已配置群组数量：2 个

💡 提示：使用 /trigger_list 查看所有群组配置
```

### 启用群的智能触发

```bash
/trigger_enable <群号>
```

**示例：**
```bash
/trigger_enable 123456789
```

**输出示例：**
```
✅ 已启用群 123456789 的智能触发

✨ 已生效 💙
```

### 禁用群的智能触发

```bash
/trigger_disable <群号>
```

**示例：**
```bash
/trigger_disable 123456789
```

**输出示例：**
```
❌ 已禁用群 123456789 的智能触发

✨ 已生效 💙
```

### 设置群的智能触发

```bash
/trigger_set <群号> <启用/禁用> [强制@:是/否]
```

**示例：**
```bash
/trigger_set 123456789 启用
/trigger_set 123456789 禁用
/trigger_set 123456789 启用 是  # 启用并强制@
```

**输出示例：**
```
✅ 已设置群 123456789：启用智能触发

✨ 已生效 💙
```

### 重置群为默认配置

```bash
/trigger_reset <群号>
```

**示例：**
```bash
/trigger_reset 123456789
```

**输出示例：**
```
✅ 已重置群 123456789 为默认配置

• 启用状态：启用
• 强制@：否

✨ 已生效 💙
```

### 查看所有群配置

```bash
/trigger_list
```

**输出示例：**
```
✨ 群组智能触发配置列表 💙

【群 123456789】
• 状态：✅ 启用
• 规则：
• 模式：[？?], (有人|谁|怎么|如何|为什么|求|帮|解答|请教), ...

【群 987654321】
• 状态：❌ 禁用
• 规则：（强制@）
• 模式：...

💡 提示：使用 /trigger_reset <群号> 恢复默认配置
```

---

## 常见问题

### Q1: 如何获取群号？

**方法1：查看日志**
```bash
# 发送一条消息后查看日志
tail -f logs/nonebot.log
```

**方法2：使用QQ客户端**
- 在群设置中查看群号
- 或在群信息中找到

**方法3：使用超级管理员命令**
- 如果已经在群里，机器人会自动获取群号

### Q2: 如何临时禁用某个群的智能触发？

```bash
/trigger_disable 123456789
```

### Q3: 如何让机器人只回复特定类型的问题？

修改群组的 `mention_patterns` 配置，只保留需要的触发模式。

例如，只回复技术问题：
```json
{
  "123456789": {
    "trigger_config": {
      "enabled": true,
      "mention_patterns": [
        "(技术|代码|bug|问题|报错|调试)",
        "(@机器人|@HELP)"
      ]
    }
  }
}
```

### Q4: 如何避免机器人回复简单问候？

在触发模式中添加排除规则：

```python
[
  "[？?]",
  "(求|帮|解答|请教)",
  "(?![你好|哈喽|在吗|嗨|早上好|晚上好])"
]
```

### Q5: 配置修改后需要重启吗？

**不需要！** 配置修改后立即生效，无需重启机器人。

### Q6: 群组配置文件丢失了怎么办？

群组配置会自动保存到 `group_configs.json` 文件。如果文件丢失：

1. 使用 `/trigger_reset <群号>` 重新配置
2. 或删除群配置后恢复默认设置

### Q7: 如何备份群组配置？

直接复制 `group_configs.json` 文件即可：

```bash
cp group_configs.json group_configs.json.backup
```

### Q8: 触发模式太多了怎么办？

建议使用更简洁的正则表达式，或者将多个模式合并为一个：

```python
# 繁琐的方式
[
  "(有人|谁)",
  "(怎么|如何)",
  "(为什么)",
  "(求|帮)"
]

# 简洁的方式
[
  "(有人|谁|怎么|如何|为什么|求|帮)"
]
```

---

## 最佳实践

### 1. 逐步启用

建议先在测试群验证配置，确认效果后再应用到生产群。

### 2. 监控触发频率

使用日志监控触发频率，避免过度回复。

### 3. 合理设置 history_limit

- **技术群**：50 条（更多上下文）
- **闲聊群**：10 条（减少噪音）
- **客服群**：30 条（适中）

### 4. 避免刷屏

不要使用 `"."` 或 `".*"` 匹配所有消息，会导致刷屏。

### 5. 定期审查配置

定期检查群组配置，移除不必要的自定义配置。

---

## 技术实现

### 核心代码文件

- `config.py` - 配置管理（群组配置加载/保存）
- `plugins/openclaw_chat/intelligent_trigger.py` - 触发检测模块
- `plugins/openclaw_chat/chat.py` - 消息处理器

### 消息处理器

```python
# @机器人处理器（优先级 1）
chat = on_message(rule=to_me(), priority=1, block=True)

# 智能触发处理器（优先级 5，不阻塞）
intelligent_chat = on_message(priority=5, block=False)
```

---

## 更新日志

- **v1.8.0 (2026-02-16)**: 智能触发功能首次发布

---

**文档版本：1.0.0**
**最后更新：2026-02-16**
